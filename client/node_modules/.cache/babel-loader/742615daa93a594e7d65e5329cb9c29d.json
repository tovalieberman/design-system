{"ast":null,"code":"var fs = require('fs');\n\nvar path = require('path');\n\nvar applySourceMaps = require('./apply-source-maps');\n\nvar extractImportUrlAndMedia = require('./extract-import-url-and-media');\n\nvar isAllowedResource = require('./is-allowed-resource');\n\nvar loadOriginalSources = require('./load-original-sources');\n\nvar normalizePath = require('./normalize-path');\n\nvar rebase = require('./rebase');\n\nvar rebaseLocalMap = require('./rebase-local-map');\n\nvar rebaseRemoteMap = require('./rebase-remote-map');\n\nvar restoreImport = require('./restore-import');\n\nvar tokenize = require('../tokenizer/tokenize');\n\nvar Token = require('../tokenizer/token');\n\nvar Marker = require('../tokenizer/marker');\n\nvar hasProtocol = require('../utils/has-protocol');\n\nvar isImport = require('../utils/is-import');\n\nvar isRemoteResource = require('../utils/is-remote-resource');\n\nvar UNKNOWN_URI = 'uri:unknown';\n\nfunction readSources(input, context, callback) {\n  return doReadSources(input, context, function (tokens) {\n    return applySourceMaps(tokens, context, function () {\n      return loadOriginalSources(context, function () {\n        return callback(tokens);\n      });\n    });\n  });\n}\n\nfunction doReadSources(input, context, callback) {\n  if (typeof input == 'string') {\n    return fromString(input, context, callback);\n  } else if (Buffer.isBuffer(input)) {\n    return fromString(input.toString(), context, callback);\n  } else if (Array.isArray(input)) {\n    return fromArray(input, context, callback);\n  } else if (typeof input == 'object') {\n    return fromHash(input, context, callback);\n  }\n}\n\nfunction fromString(input, context, callback) {\n  context.source = undefined;\n  context.sourcesContent[undefined] = input;\n  context.stats.originalSize += input.length;\n  return fromStyles(input, context, {\n    inline: context.options.inline\n  }, callback);\n}\n\nfunction fromArray(input, context, callback) {\n  var inputAsImports = input.reduce(function (accumulator, uriOrHash) {\n    if (typeof uriOrHash === 'string') {\n      return addStringSource(uriOrHash, accumulator);\n    } else {\n      return addHashSource(uriOrHash, context, accumulator);\n    }\n  }, []);\n  return fromStyles(inputAsImports.join(''), context, {\n    inline: ['all']\n  }, callback);\n}\n\nfunction fromHash(input, context, callback) {\n  var inputAsImports = addHashSource(input, context, []);\n  return fromStyles(inputAsImports.join(''), context, {\n    inline: ['all']\n  }, callback);\n}\n\nfunction addStringSource(input, imports) {\n  imports.push(restoreAsImport(normalizeUri(input)));\n  return imports;\n}\n\nfunction addHashSource(input, context, imports) {\n  var uri;\n  var normalizedUri;\n  var source;\n\n  for (uri in input) {\n    source = input[uri];\n    normalizedUri = normalizeUri(uri);\n    imports.push(restoreAsImport(normalizedUri));\n    context.sourcesContent[normalizedUri] = source.styles;\n\n    if (source.sourceMap) {\n      trackSourceMap(source.sourceMap, normalizedUri, context);\n    }\n  }\n\n  return imports;\n}\n\nfunction normalizeUri(uri) {\n  var currentPath = path.resolve('');\n  var absoluteUri;\n  var relativeToCurrentPath;\n  var normalizedUri;\n\n  if (isRemoteResource(uri)) {\n    return uri;\n  }\n\n  absoluteUri = path.isAbsolute(uri) ? uri : path.resolve(uri);\n  relativeToCurrentPath = path.relative(currentPath, absoluteUri);\n  normalizedUri = normalizePath(relativeToCurrentPath);\n  return normalizedUri;\n}\n\nfunction trackSourceMap(sourceMap, uri, context) {\n  var parsedMap = typeof sourceMap == 'string' ? JSON.parse(sourceMap) : sourceMap;\n  var rebasedMap = isRemoteResource(uri) ? rebaseRemoteMap(parsedMap, uri) : rebaseLocalMap(parsedMap, uri || UNKNOWN_URI, context.options.rebaseTo);\n  context.inputSourceMapTracker.track(uri, rebasedMap);\n}\n\nfunction restoreAsImport(uri) {\n  return restoreImport('url(' + uri + ')', '') + Marker.SEMICOLON;\n}\n\nfunction fromStyles(styles, context, parentInlinerContext, callback) {\n  var tokens;\n  var rebaseConfig = {};\n\n  if (!context.source) {\n    rebaseConfig.fromBase = path.resolve('');\n    rebaseConfig.toBase = context.options.rebaseTo;\n  } else if (isRemoteResource(context.source)) {\n    rebaseConfig.fromBase = context.source;\n    rebaseConfig.toBase = context.source;\n  } else if (path.isAbsolute(context.source)) {\n    rebaseConfig.fromBase = path.dirname(context.source);\n    rebaseConfig.toBase = context.options.rebaseTo;\n  } else {\n    rebaseConfig.fromBase = path.dirname(path.resolve(context.source));\n    rebaseConfig.toBase = context.options.rebaseTo;\n  }\n\n  tokens = tokenize(styles, context);\n  tokens = rebase(tokens, context.options.rebase, context.validator, rebaseConfig);\n  return allowsAnyImports(parentInlinerContext.inline) ? inline(tokens, context, parentInlinerContext, callback) : callback(tokens);\n}\n\nfunction allowsAnyImports(inline) {\n  return !(inline.length == 1 && inline[0] == 'none');\n}\n\nfunction inline(tokens, externalContext, parentInlinerContext, callback) {\n  var inlinerContext = {\n    afterContent: false,\n    callback: callback,\n    errors: externalContext.errors,\n    externalContext: externalContext,\n    fetch: externalContext.options.fetch,\n    inlinedStylesheets: parentInlinerContext.inlinedStylesheets || externalContext.inlinedStylesheets,\n    inline: parentInlinerContext.inline,\n    inlineRequest: externalContext.options.inlineRequest,\n    inlineTimeout: externalContext.options.inlineTimeout,\n    isRemote: parentInlinerContext.isRemote || false,\n    localOnly: externalContext.localOnly,\n    outputTokens: [],\n    rebaseTo: externalContext.options.rebaseTo,\n    sourceTokens: tokens,\n    warnings: externalContext.warnings\n  };\n  return doInlineImports(inlinerContext);\n}\n\nfunction doInlineImports(inlinerContext) {\n  var token;\n  var i, l;\n\n  for (i = 0, l = inlinerContext.sourceTokens.length; i < l; i++) {\n    token = inlinerContext.sourceTokens[i];\n\n    if (token[0] == Token.AT_RULE && isImport(token[1])) {\n      inlinerContext.sourceTokens.splice(0, i);\n      return inlineStylesheet(token, inlinerContext);\n    } else if (token[0] == Token.AT_RULE || token[0] == Token.COMMENT) {\n      inlinerContext.outputTokens.push(token);\n    } else {\n      inlinerContext.outputTokens.push(token);\n      inlinerContext.afterContent = true;\n    }\n  }\n\n  inlinerContext.sourceTokens = [];\n  return inlinerContext.callback(inlinerContext.outputTokens);\n}\n\nfunction inlineStylesheet(token, inlinerContext) {\n  var uriAndMediaQuery = extractImportUrlAndMedia(token[1]);\n  var uri = uriAndMediaQuery[0];\n  var mediaQuery = uriAndMediaQuery[1];\n  var metadata = token[2];\n  return isRemoteResource(uri) ? inlineRemoteStylesheet(uri, mediaQuery, metadata, inlinerContext) : inlineLocalStylesheet(uri, mediaQuery, metadata, inlinerContext);\n}\n\nfunction inlineRemoteStylesheet(uri, mediaQuery, metadata, inlinerContext) {\n  var isAllowed = isAllowedResource(uri, true, inlinerContext.inline);\n  var originalUri = uri;\n  var isLoaded = uri in inlinerContext.externalContext.sourcesContent;\n  var isRuntimeResource = !hasProtocol(uri);\n\n  if (inlinerContext.inlinedStylesheets.indexOf(uri) > -1) {\n    inlinerContext.warnings.push('Ignoring remote @import of \"' + uri + '\" as it has already been imported.');\n    inlinerContext.sourceTokens = inlinerContext.sourceTokens.slice(1);\n    return doInlineImports(inlinerContext);\n  } else if (inlinerContext.localOnly && inlinerContext.afterContent) {\n    inlinerContext.warnings.push('Ignoring remote @import of \"' + uri + '\" as no callback given and after other content.');\n    inlinerContext.sourceTokens = inlinerContext.sourceTokens.slice(1);\n    return doInlineImports(inlinerContext);\n  } else if (isRuntimeResource) {\n    inlinerContext.warnings.push('Skipping remote @import of \"' + uri + '\" as no protocol given.');\n    inlinerContext.outputTokens = inlinerContext.outputTokens.concat(inlinerContext.sourceTokens.slice(0, 1));\n    inlinerContext.sourceTokens = inlinerContext.sourceTokens.slice(1);\n    return doInlineImports(inlinerContext);\n  } else if (inlinerContext.localOnly && !isLoaded) {\n    inlinerContext.warnings.push('Skipping remote @import of \"' + uri + '\" as no callback given.');\n    inlinerContext.outputTokens = inlinerContext.outputTokens.concat(inlinerContext.sourceTokens.slice(0, 1));\n    inlinerContext.sourceTokens = inlinerContext.sourceTokens.slice(1);\n    return doInlineImports(inlinerContext);\n  } else if (!isAllowed && inlinerContext.afterContent) {\n    inlinerContext.warnings.push('Ignoring remote @import of \"' + uri + '\" as resource is not allowed and after other content.');\n    inlinerContext.sourceTokens = inlinerContext.sourceTokens.slice(1);\n    return doInlineImports(inlinerContext);\n  } else if (!isAllowed) {\n    inlinerContext.warnings.push('Skipping remote @import of \"' + uri + '\" as resource is not allowed.');\n    inlinerContext.outputTokens = inlinerContext.outputTokens.concat(inlinerContext.sourceTokens.slice(0, 1));\n    inlinerContext.sourceTokens = inlinerContext.sourceTokens.slice(1);\n    return doInlineImports(inlinerContext);\n  }\n\n  inlinerContext.inlinedStylesheets.push(uri);\n\n  function whenLoaded(error, importedStyles) {\n    if (error) {\n      inlinerContext.errors.push('Broken @import declaration of \"' + uri + '\" - ' + error);\n      return process.nextTick(function () {\n        inlinerContext.outputTokens = inlinerContext.outputTokens.concat(inlinerContext.sourceTokens.slice(0, 1));\n        inlinerContext.sourceTokens = inlinerContext.sourceTokens.slice(1);\n        doInlineImports(inlinerContext);\n      });\n    }\n\n    inlinerContext.inline = inlinerContext.externalContext.options.inline;\n    inlinerContext.isRemote = true;\n    inlinerContext.externalContext.source = originalUri;\n    inlinerContext.externalContext.sourcesContent[uri] = importedStyles;\n    inlinerContext.externalContext.stats.originalSize += importedStyles.length;\n    return fromStyles(importedStyles, inlinerContext.externalContext, inlinerContext, function (importedTokens) {\n      importedTokens = wrapInMedia(importedTokens, mediaQuery, metadata);\n      inlinerContext.outputTokens = inlinerContext.outputTokens.concat(importedTokens);\n      inlinerContext.sourceTokens = inlinerContext.sourceTokens.slice(1);\n      return doInlineImports(inlinerContext);\n    });\n  }\n\n  return isLoaded ? whenLoaded(null, inlinerContext.externalContext.sourcesContent[uri]) : inlinerContext.fetch(uri, inlinerContext.inlineRequest, inlinerContext.inlineTimeout, whenLoaded);\n}\n\nfunction inlineLocalStylesheet(uri, mediaQuery, metadata, inlinerContext) {\n  var currentPath = path.resolve('');\n  var absoluteUri = path.isAbsolute(uri) ? path.resolve(currentPath, uri[0] == '/' ? uri.substring(1) : uri) : path.resolve(inlinerContext.rebaseTo, uri);\n  var relativeToCurrentPath = path.relative(currentPath, absoluteUri);\n  var importedStyles;\n  var isAllowed = isAllowedResource(uri, false, inlinerContext.inline);\n  var normalizedPath = normalizePath(relativeToCurrentPath);\n  var isLoaded = normalizedPath in inlinerContext.externalContext.sourcesContent;\n\n  if (inlinerContext.inlinedStylesheets.indexOf(absoluteUri) > -1) {\n    inlinerContext.warnings.push('Ignoring local @import of \"' + uri + '\" as it has already been imported.');\n  } else if (!isLoaded && (!fs.existsSync(absoluteUri) || !fs.statSync(absoluteUri).isFile())) {\n    inlinerContext.errors.push('Ignoring local @import of \"' + uri + '\" as resource is missing.');\n  } else if (!isAllowed && inlinerContext.afterContent) {\n    inlinerContext.warnings.push('Ignoring local @import of \"' + uri + '\" as resource is not allowed and after other content.');\n  } else if (inlinerContext.afterContent) {\n    inlinerContext.warnings.push('Ignoring local @import of \"' + uri + '\" as after other content.');\n  } else if (!isAllowed) {\n    inlinerContext.warnings.push('Skipping local @import of \"' + uri + '\" as resource is not allowed.');\n    inlinerContext.outputTokens = inlinerContext.outputTokens.concat(inlinerContext.sourceTokens.slice(0, 1));\n  } else {\n    importedStyles = isLoaded ? inlinerContext.externalContext.sourcesContent[normalizedPath] : fs.readFileSync(absoluteUri, 'utf-8');\n    inlinerContext.inlinedStylesheets.push(absoluteUri);\n    inlinerContext.inline = inlinerContext.externalContext.options.inline;\n    inlinerContext.externalContext.source = normalizedPath;\n    inlinerContext.externalContext.sourcesContent[normalizedPath] = importedStyles;\n    inlinerContext.externalContext.stats.originalSize += importedStyles.length;\n    return fromStyles(importedStyles, inlinerContext.externalContext, inlinerContext, function (importedTokens) {\n      importedTokens = wrapInMedia(importedTokens, mediaQuery, metadata);\n      inlinerContext.outputTokens = inlinerContext.outputTokens.concat(importedTokens);\n      inlinerContext.sourceTokens = inlinerContext.sourceTokens.slice(1);\n      return doInlineImports(inlinerContext);\n    });\n  }\n\n  inlinerContext.sourceTokens = inlinerContext.sourceTokens.slice(1);\n  return doInlineImports(inlinerContext);\n}\n\nfunction wrapInMedia(tokens, mediaQuery, metadata) {\n  if (mediaQuery) {\n    return [[Token.NESTED_BLOCK, [[Token.NESTED_BLOCK_SCOPE, '@media ' + mediaQuery, metadata]], tokens]];\n  } else {\n    return tokens;\n  }\n}\n\nmodule.exports = readSources;","map":null,"metadata":{},"sourceType":"script"}